# smbmetrics — Prometheus exporter for Samba.
#
# How it works:
#   The operator injects smbmetrics as a sidecar into each samba pod when
#   SAMBA_OP_METRICS_EXPORTER_MODE=enabled is set on the operator Deployment.
#   The sidecar shares /run and /var/lib/samba volumes with smbd, which gives
#   smbstatus access to smbd's Unix sockets and tdb state databases.
#   Metrics are exposed on port 8080.
#
# Bug in samba-operator v0.8 (fixed in BenEstrabaud/samba-operator#fix-smbmetrics-port):
#   buildSmbMetricsContainer() hardcodes liveness/readiness probes on port 8080
#   but never passes --port 8080 to the binary.  The binary defaults to 9922,
#   so the probes fail → CrashLoopBackOff.  The one-line fix adds:
#     Args: []string{fmt.Sprintf("--port=%d", portnum)}
#
# Additionally, the per-share metrics Service and ServiceMonitor are only
# auto-created on OpenShift (IsOpenShiftCluster() guard in the operator).
# On vanilla k8s we create both manually (below).
#
# To enable (requires the operator fix above to be deployed):
#   1. kubectl set env deployment/samba-operator-controller-manager \
#        -n samba-operator-system SAMBA_OP_METRICS_EXPORTER_MODE=enabled
#   2. kubectl apply -f manifests/smbmetrics.yaml
#   3. Delete the SmbShare pods so the operator recreates them with the sidecar:
#        kubectl delete pods -n samba -l app=samba
#      (operator only injects the sidecar on pod creation, not update)

---
# ---------- Metrics Service (samba namespace) ----------
# The operator does NOT create a metrics Service on vanilla k8s (only OpenShift).
# This headless Service selects all samba share pods and exposes the smbmetrics
# sidecar port (8080) so the ServiceMonitor below can discover them.
# One Prometheus target is created per samba pod (timemachine, storage, …).
apiVersion: v1
kind: Service
metadata:
  name: samba-metrics
  namespace: samba
  labels:
    app.kubernetes.io/component: smbmetrics
    app.kubernetes.io/managed-by: samba-operator
spec:
  clusterIP: None   # headless — one Prometheus target per pod
  selector:
    app.kubernetes.io/name: samba
  ports:
    - name: smbmetrics
      port: 8080
      targetPort: 8080

---
# ---------- ServiceMonitor (monitoring namespace) ----------
# Discovers samba-metrics (above) in the samba namespace and tells Prometheus
# to scrape the smbmetrics sidecar on port 8080.
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: smbmetrics
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  namespaceSelector:
    matchNames:
      - samba
  selector:
    matchLabels:
      app.kubernetes.io/component: smbmetrics
  endpoints:
    - port: smbmetrics
      interval: 30s
