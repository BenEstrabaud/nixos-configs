# NetworkPolicies for the monitoring namespace.
#
# Default posture: deny all ingress and egress, then selectively re-open only
# the paths that are required for the monitoring stack to function.
#
# Note: samba-operator-system is intentionally left without NetworkPolicies —
# the operator requires complex API-server access that is difficult to enumerate
# without risking breaking it; its RBAC rules already limit what it can do.

# ---------- Default deny ----------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes: [Ingress, Egress]

---
# ---------- DNS (all pods) ----------
# Every pod in the namespace needs to resolve cluster-internal DNS.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes: [Egress]
  egress:
    - ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

---
# ---------- Grafana ----------
# Ingress: MetalLB LoadBalancer forwards external traffic to pod port 3000.
# Egress:  queries Thanos Query (primary datasource) and Prometheus (secondary).
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  policyTypes: [Ingress, Egress]
  ingress:
    - ports:
        - port: 3000
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: thanos
              app.kubernetes.io/component: query
      ports:
        - port: 9090
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 9090
    # Grafana sidecar (grafana-sc-dashboard) watches ConfigMaps for dashboard injection
    - ports:
        - port: 443
        - port: 6443

---
# ---------- Prometheus ----------
# Ingress: Grafana datasource queries (9090); Thanos Query gRPC to the
#          Thanos sidecar that runs inside this pod (10901); Operator management.
# Egress:  scrape targets in this namespace; alert dispatch to Alertmanager;
#          Kubernetes API server for service-discovery and kube-system scrapes.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prometheus
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - port: 9090
    # Thanos Query calls the sidecar (co-located inside this pod) via gRPC
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: thanos
              app.kubernetes.io/component: query
      ports:
        - port: 10901
    # Prometheus Operator manages configuration via secrets; also health-checks
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kube-prometheus-stack-prometheus-operator
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus-node-exporter
      ports:
        - port: 9100
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kube-state-metrics
      ports:
        - port: 8080
    # smartctl-exporter pod port is 9633 (service maps 80 → 9633)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus-smartctl-exporter
      ports:
        - port: 9633
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager
      ports:
        - port: 9093
    # kube-system: CoreDNS metrics (9153) and other default k3s scrape targets
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - port: 9153   # CoreDNS /metrics
        - port: 10249  # kube-proxy
        - port: 10250  # kubelet
        - port: 10255  # kubelet read-only
    # smbmetrics sidecar in samba namespace (operator-injected, port 8080)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: samba
      ports:
        - port: 8080
    # Kubernetes API server: service discovery + scraping apiserver metrics
    - ports:
        - port: 443
        - port: 6443

---
# ---------- Thanos Query ----------
# Fans out queries to the Prometheus Thanos sidecar and the StoreGateway.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: thanos-query
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: thanos
      app.kubernetes.io/component: query
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - port: 9090
  egress:
    # Thanos sidecar runs inside the Prometheus pod (same pod labels)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 10901
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: thanos
              app.kubernetes.io/component: storegateway
      ports:
        - port: 10901

---
# ---------- Thanos StoreGateway ----------
# Serves historical TSDB blocks (from /data/thanos hostPath) to Thanos Query.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: thanos-storegateway
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: thanos
      app.kubernetes.io/component: storegateway
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: thanos
              app.kubernetes.io/component: query
      ports:
        - port: 10901

---
# ---------- Thanos Compactor ----------
# Reads and writes the /data/thanos hostPath only; no network peers needed.
# DNS egress is covered by the namespace-wide allow-dns-egress policy.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: thanos-compactor
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: thanos
      app.kubernetes.io/component: compactor
  policyTypes: [Ingress, Egress]

---
# ---------- Alertmanager ----------
# Receives firing alerts from Prometheus; dispatches them via SMTP.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: alertmanager
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 9093
  egress:
    - ports:
        - port: 587   # SMTP/TLS for alert emails

---
# ---------- Prometheus Operator ----------
# Watches Kubernetes API for CRD changes; runs an admission webhook which the
# API server calls back on (source IP = node, not a pod — allow all ingress).
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-operator
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: kube-prometheus-stack-prometheus-operator
  policyTypes: [Ingress, Egress]
  ingress:
    - {}   # API server webhooks arrive from the node IP; allow all ingress
  egress:
    # Kubernetes API server
    - ports:
        - port: 443
        - port: 6443
    # Reconcile: read Prometheus and Alertmanager pod status
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager

---
# ---------- node-exporter ----------
# Exposes host metrics; only scraped by Prometheus.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: node-exporter
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prometheus-node-exporter
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 9100

---
# ---------- kube-state-metrics ----------
# Watches Kubernetes objects via the API server; exposes metrics to Prometheus.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kube-state-metrics
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: kube-state-metrics
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 8080
  egress:
    - ports:
        - port: 443
        - port: 6443

---
# ---------- smartctl-exporter ----------
# Exposes SMART disk metrics; only scraped by Prometheus on pod port 9633.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: smartctl-exporter
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prometheus-smartctl-exporter
  policyTypes: [Ingress, Egress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 9633
